sudo: required

language: go

go:
  - 1.11

env:
  global:
    - GO111MODULE=on
    - GORELEASER_ON=1

script:
  - go test -race -coverprofile=coverage.txt -covermode=atomic -v ./...
  - GOOS=linux go build

after_success:
  - curl -sL https://codecov.io/bash | bash

before_deploy:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

deploy:
  - provider: script
    script: bash -l docker-push.sh
    skip_cleanup: true
    on:
      branch: master
      repo: aswinkarthik/csvdiff
      tags: true
  - provider: script
    script: curl -sL https://git.io/goreleaser | bash
    skip_cleanup: true
    on:
      branch: master
      tags: true
      repo: aswinkarthik/csvdiff
      condition: $GORELEASER_ON = 1